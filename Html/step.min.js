const BLOCKEND = { 
  scope: 'title',
  begin: '^\\[end\\]',
  end: '$'
};

const DECLARATION = {
  scope: 'keyword',
  begin: '^\\[[^A-Z]',
  end: '$'
};

const QUOTED_STRING = {
  scope: 'string',
  begin: '"',
  end: '"'
};

const SMARTY_PATNS_QUOTED_STRING = {
  scope: 'string',
  begin: '\\u201c',
  end: '\\u201d'
};

const PIPE_STRING = {
  scope: 'string',
  begin: '\\|[^ ]',
  end: '\\|'
};

const SYMBOL_STRING = {
  scope: 'string',
  begin: '[a-z][a-zA-Z0-9_]*',
};

const OPERATOR = {
  scope: 'operator',
  begin: '\\|[ \\?]',
};

const GLOBAL_VARIABLE = {
  scope: 'variable',
  begin: '[A-Z]\\w*'
};

const LOCAL_VARIABLE = {
  scope: 'variable',
  begin: '\\?\\w*'
};

const COMMENT = hljs.HASH_COMMENT_MODE;

const TUPLE = {
  begin: '\\[',
  beginScope: 'literal',
  end: '\\]',
  endScope: 'literal',
  scope: 'literal',
  contains: [
    'self',
    QUOTED_STRING,
    SMARTY_PATNS_QUOTED_STRING,
    PIPE_STRING,
    SYMBOL_STRING,
    OPERATOR,
    GLOBAL_VARIABLE,
    LOCAL_VARIABLE
  ]
};

const CALL = {
  begin: ' \\[',
  scope: 'variable',
  end: '\\]',
  endsWithParent: true,
  contains: [
    TUPLE,
    QUOTED_STRING,
    SMARTY_PATNS_QUOTED_STRING,
    PIPE_STRING,
    SYMBOL_STRING,
    OPERATOR,
    GLOBAL_VARIABLE,
    LOCAL_VARIABLE
  ]
};

const TOPLEVELCALL = {
  begin: '^\\[',
  scope: 'variable',
  end: '\\]',
  endsWithParent: true,
  contains: [
    TUPLE,
    QUOTED_STRING,
    SMARTY_PATNS_QUOTED_STRING,
    PIPE_STRING,
    SYMBOL_STRING,
    OPERATOR,
    GLOBAL_VARIABLE,
    LOCAL_VARIABLE
  ]
};

const VARIABLE_INTERPOLATION = {
  match: "[\\?\\^][a-zA-Z0-9_/]+",
  scope: "variable"
};

const SINGLE_LINE_BODY = {
  scope: 'string',
  begin: ':',
  beginScope: 'punctuation',
  end: '$',
  contains: [ CALL, VARIABLE_INTERPOLATION ]
}

const MULTILINE_BODY = {
  scope: 'string',
  begin: '^[  ]',
  beginScope: 'punctuation',
  end: '$',
  endScope: 'title.function',
  contains: [ CALL, VARIABLE_INTERPOLATION ]
}

hljs.registerLanguage('step', function() {
    return {
      keywords: {
          meta: 'predicate task randomly generator fallable',
          keyword: 'end set now initially',
          literal: ['false','true','null'],
      },
      scope: 'meta',
      contains: [
        {
          scope: 'title.function',
          begin: '^[A-Z][a-zA-Z0-9_]*',
        },
        BLOCKEND,
        DECLARATION,
        TOPLEVELCALL,
        TUPLE,
        QUOTED_STRING,
        SMARTY_PATNS_QUOTED_STRING,
        PIPE_STRING,
        SYMBOL_STRING,
        OPERATOR,
        GLOBAL_VARIABLE,
        LOCAL_VARIABLE,
        COMMENT,
        SINGLE_LINE_BODY,
        MULTILINE_BODY
      ]
    }
  })