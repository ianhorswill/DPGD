
<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- generic metadata -->
	<title>A clairvoyant map generator&#xA;</title>
	<meta name="author" content="Ian Horswill">
	<meta name="description" content="An introduction to declarative programming with applications to vidoegames">
	<meta name="generator" content="Booker">

	<!-- seo helpers: generic, twitter, facebook/opengraph -->
	<meta itemprop="name" content="A clairvoyant map generator&#xA;">
	<meta name="twitter:title" content="A clairvoyant map generator&#xA;">
	<meta property="og:title" content="A clairvoyant map generator&#xA;" />
	<meta property="og:type" content="article" />
	<meta property="og:site_name" content="Declarative Programming for Game Designers" />
	
	<!-- stylesheets -->
	<!-- bootstrap needs to come first -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

	<!-- then our style sheet -->
	<link rel="stylesheet" href="site.css"> 

	<!-- sample fonts, please feel free to replace with your preferred ones -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat|Public+Sans:400,700&display=swap&subset=latin-ext"> 

	<!-- highlightjs is used for source code formatting inside <code> tags. feel free to remove it. -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/atom-one-dark.min.css">
	<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>
	<script src="step.js"></script>
	<script src="NDScript.js"></script>
	<script>hljs.highlightAll();</script>
	
	<!-- use MathJax for latex rendering -->
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

	<!-- Use mermaid to render diagrams -->
	<script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>
</head>

<body>
<div class="container-fluid shadow header">
	<div class="container">
		<div class="col-md-7 header-contents">
				<a class="backgroundlink" href="Part_I.html"> Part I
 </a>
&nbsp;&#x25BB;&nbsp;				<a class="backgroundlink" href="Clairvoyant_programming.html"> Clairvoyant programming
 </a>
&nbsp;&#x25BB;&nbsp;				<a class="backgroundlink" href="NDScript.html"> Clairvoyant algorithms
 </a>
&nbsp;&#x25BB;&nbsp;				<a class="backgroundlink" href="Map_generation.html"> Map generation
 </a>
			<h1><a id="linkToIndex" class="simplelink" href="index.html"> A clairvoyant map generator
</a></h1>
					<p>
					<span style="padding:.25rem; padding-left:.5rem; padding-right:.5rem; background-color:orange; color:black;">
					   alpha test
					</span>
					</p>
		</div>
	</div>
</div>

	<!-- Make clicking On Step code pop up a step interpreter and copy the code into the clipboard -->
	<script>
	document.querySelector("body").addEventListener('click', function(e) {
		var element = e.target.closest('code');
		if(element !== null) {
			if (element.classList.contains('language-Step')) {
				var interp = window.open("https://ianhorswill.github.io/StepSandbox", "Step sandbox");
				var handler = function(e) { 
					interp.postMessage(element.textContent, "*");
					window.removeEventListener('message', handler);
				};
				window.addEventListener('message', handler);
			} else if (element.classList.contains('language-NDScript')) {
				var interp = window.open("https://ianhorswill.github.io/NDScriptSandbox", "NDScript sandbox");
				var handler = function(e) { 
					interp.postMessage(element.textContent, "*");
					window.removeEventListener('message', handler);
				};
				window.addEventListener('message', handler);
			}
		}
	}, false);
	</script>



<div class="container-fluid">
	<div class="row justify-content-center">
		<div class="col-md-7 index-contents">
			<div class="container shadow blog-contents">

<p>Let's write a generator in NDScript.  If you don't want to think about code for the moment, skip to <a href="#try-it-out">the end of this page</a>, and you can click on a runnable version of it.</p>
<p>As we did in the example, we'll use a brown tile to represent sand, green for grass, and blue for water.  However, we'll put those names in variables with more meaningful names:</p>
<pre><code class="language-ndscript">var sand = &quot;brown&quot;;
var grass = &quot;green&quot;;
var water = &quot;blue&quot;;
</code></pre>
<h2 id="data-structures">Data structures</h2>
<p>We'll represent the map as a grid, as we did in the pathfinder.  However, this time the entries in the grid will be sets of tiles rather than individual tiles:</p>
<pre><code class="language-ndscript">// 10x10 grid with each cell initialized to the set: { sand, grass, water }
var g = makeGrid(10, 10, setOf(sand, grass, water));
</code></pre>
<p>If you haven't encountered <a href="Sets.html">sets</a> before, they're a lot like lists or arrays.  The difference is that lists and arrays track what position an element is in (i.e. <code>[1, 2]</code> is a different array than <code>[2, 1]</code>) and can allow the same value to be in many positions (i.e. <code>[1, 1]</code> is different from just <code>[1]</code>).  Sets don't make either of those distinctions.  Something either is an element of a set or it isn't, but it can't be in it multiple times or in different positions.</p>
<p>We'll represent the constraint using a <a href="Relations.html">relation</a>.  For the moment, you can think of a relation as a function from two inputs to a Boolean: it either says &ldquo;yes, this relationship holds between the arguments&rdquo; or &quot;no, it doesn't.&quot;  It's a pain to write one as a big <code>if</code>/<code>then</code>/<code>else</code>, so we've provided a <code>relation</code> primitive that takes a list of argument pairs that it should return true for.  It returns false for other pairs:</p>
<pre><code class="language-ndscript">// What tiles can be adjaccent to what other tiles.
// Any combination is allowed EXCEPT water next to grass.
// This forces there to be a sand tile between any pair of
// water and grass tiles.
var compatible = relation(
   // You can put anything next to sand
   [sand, grass], [sand, water], [sand, sand],
   // You can put sand or more water next to water
   [water, water], [water, sand],
   // You can put sand or more grass next to grass
   [grass, grass], [grass, sand]);
</code></pre>
<h2 id="choice-loop">Choice loop</h2>
<p>Our outer loop repeatedly picks a position (X-Y coordinates for a cell) that isn't already a singleton (isn't already a single value) and chooses a tile from the position's set of remaining possible tiles.</p>
<pre><code class="language-ndscript">var p = chooseElement(remaining);
narrowTo(p, setOf(chooseElement(g[p])));
</code></pre>
<p>Here,</p>
<ul>
<li><code>remaining</code> is the set of positions in <code>g</code> that haven't already been narrowed to singletons.</li>
<li>The primitive <code>chooseElement</code> takes a set and clairvoyantly guesses an element of it that won't lead to <code>fail</code>ing.</li>
<li>The procedure <code>narrowTo(position, restriction)</code>, which we will write below, removes any tiles from <code>g[position]</code> that aren't in <code>restriction</code>, and then propagates those changes to neighboring tiles.</li>
</ul>
<p>So this code fragment chooses a position, chooses a tile from that position's remaining set of allowable tiles, and narrows that position to just that tile, propagating any effects through the grid.</p>
<p>The loop looks like this:</p>
<pre><code class="language-ndscript">function solve() {
    var remaining = nonsingletonPositionsOf(g);
    while (!isEmpty(remaining)) {
      var p = chooseElement(remaining);
      narrowTo(p, setOf(chooseElement(g[p])));
      remaining = nonsingletonPositionsOf(g);
    }
}
</code></pre>
<h2 id="narrowing-and-propagation">Narrowing and propagation</h2>
<p>Finally, we need to write <code>narrowTo(position, restriction)</code>, which restricts the set of allowable tiles at <code>position</code> to only elements in the set <code>restriction</code>.  Note that this is different from setting <code>g[position] = restriction</code>; instead it sets <code>g[position]</code> to the tiles that are allowed both by the current set in <code>g[position]</code> and the new <code>restriction</code>.  That is, the <a href="Set_operations.html">intersection</a> of the two sets (the elements common to both):</p>
<pre><code class="language-ndscript">// Restrict the tile at position to only tiles in the specified set
function narrowTo(position, restriction) {
  var old = g[position];
  var new = intersection(old, restriction);
  g[position] = new;
}
</code></pre>
<p>That updates the one cell, but now we want to propagate that change to the neighbors.  We only need to do that if we've actually changed the tiles at position (i.e. if <code>old != new</code>).  But if so, we need to compute the set of tiles that are allowed to be next to that reduced set of tiles.  That set of neighbor tiles compatible with <code>new</code> is called the <a href="Images_of_relations.html">image</a> of <code>new</code> through the <code>compatible</code> relation, and NDScript has a built-in function that computes it.</p>
<pre><code class="language-ndscript">var neighborCompatible = rightImage(compatible, new);
</code></pre>
<p>Having computed that, all we have to do is narrow all the neighbors to the image.  Here's the code:</p>
<pre><code class="language-ndscript">// Restrict the tile at position to only tiles in the specified set
// If that removes candidate tiles, then update neighboring
// positions to only the tiles compatible with the new, limited
// candidate tiles for this position.
deterministic function narrowTo(position, restriction) {
  var old = g[position];
  var new = intersection(old, restriction);
  if (old != new) {
     g[position] = new;
     var neighborCompatible = rightImage(compatible, new);
     foreach (n in neighborsOf(position, g))
       narrowTo(n, neighborCompatible);
  }
}
</code></pre>
<p>Ignore the <code>deterministic</code> keyword for the moment.  It's an optimization declaration.<a id="fnref:1" href="#fn:1" class="footnote-ref"><sup>1</sup></a></p>
<p>This is basically a simplified version of <a href="https://en.wikipedia.org/wiki/AC-3_algorithm">the standard constraint-propagation algorithm</a> that people use to solve constraint satisfaction problems.  The real version uses a queue of tiles that need to be updated rather than recursion.  We just used the recursive version because it's slightly simpler.  We'll talk about the real version and how you write high performance implementations of it in <a href="Part_II.html">Part II</a>.</p>
<h2 id="try-it-out">Try it out</h2>
<p>Here's the complete code.  Give it a try.  Note that we've added an extra print call in <code>solve</code>.  If you leave it commented out, you'll just see the final result.  If you uncomment it, you can watch the results of each iteration:</p>
<pre><code class="language-NDScript">// Tiles: sand, grass, and water
var sand = &quot;brown&quot;;
var grass = &quot;green&quot;;
var water = &quot;blue&quot;;

// 10x10 grid with each cell initialized to the set { sand, grass, water }
var g = makeGrid(10, 10, setOf(sand, grass, water));

// What tiles can be adjaccent to what other tiles.
// Any combination is allowed EXCEPT water next to grass.
// This forces there to be a sand tile between any pair of
// water and grass tiles.
var compatible = relation(
   [sand, grass], [sand, water], [sand, sand],
   [water, water], [water, sand],
   [grass, grass], [grass, sand]);

function solve() {
    var remaining = nonsingletonPositionsOf(g);
    while (!isEmpty(remaining)) {
      var p = chooseElement(remaining);
      narrowTo(p, setOf(chooseElement(g[p])));
      remaining = nonsingletonPositionsOf(g);
      // printTilesetMap(g, &quot;gray&quot;);
    }
}

// Restrict the tile at position to only tiles in the specified set
// If that removes candidate tiles, then update neighboring
// positions to only the tiles compatible with the new, limited
// candidate tiles for this position.
deterministic function narrowTo(position, restriction) {
  var old = g[position];
  var new = intersection(old, restriction);
  if (old != new) {
     g[position] = new;
     var neighborCompatible = rightImage(compatible, new);
     foreach (n in neighborsOf(position, g))
       narrowTo(n, neighborCompatible);
  }
}

solve();
printTilesetMap(g, &quot;gray&quot;);
</code></pre>
<h2 id="notes">Notes</h2>
<div class="footnotes">
<hr />
<ol>
<li id="fn:1">
<p>Esoteric: one of the problems with non-deterministic languages is that if procedure either contains a choice operation (a <code>choose</code> statement or a <code>chooseElement</code> call, etc.) or calls something that contains a choice operation, then it can't actually deallocate its stack frame when it returns.  That's because if something <code>fails</code> downstream, we need to wake the procedure up and restart it from its last choice point.  Unoptimized implementations like NDScript just leave everything on the stack until the program completes.  As a result, NDScript programs eat stack space and tend to fill the stack easily.  The <code>deterministic</code> keyword promises that the <code>narrowTo</code> function involves no choices and so can free up its stack space upon completion.<a href="#fnref:1" class="footnote-back-ref">&#8617;</a></p>
</li>
</ol>
</div>


<table style="border: none; width: 100%; table-layout: fixed; margin-top: 2rem;">
<tbody>
<tr style="border: none;">
				<td style="border: none; vertical-align: top; "> 
                    <b>Previous:</b> 
					<a title="Click or press &#8592;" class="simplelink" id="PreviousPage" href="Propagating_constraints.html">Propagating constraints
</a><br>
				</td>
				<td style="border: none; vertical-align: top; text-align: right;"> 
                    <b>Next:</b>  
					<a title="Click or press &#8594;" class="simplelink" id="NextPage" href="An_adjustable_version.html">Tuning it
</a><br>
				</td>			
</tr>
</tbody>
</table>
			</div>
		</div>

		<div class="col-md-3">

<div class="container-fluid sidebar">
		<h3 style="text-align: right;">Incomplete draft:<br>do not cite!</h3>
				<p style="color: grey; padding-bottom: 0rem; margin-bottom: 0rem;">Section 1.1.1.4.4</p>
			<h5>Map generation
</h5>
			<ol start="1">
					<li class="sidebar"><a class="backgroundlink" href="Early_checking.html" id="section_page_1"> Early checking
 </a> <br></li>
					<li class="sidebar"><a class="backgroundlink" href="Tracking_sets_of_tiles.html" id="section_page_2"> Tracking viable tiles
 </a> <br></li>
					<li class="sidebar"><a class="backgroundlink" href="Propagating_constraints.html" id="section_page_3"> Propagating constraints
 </a> <br></li>
					<li class="sidebar"><a class="simplelink" href="Writing_a_constraint_propagator.html" id="section_page_4"> <b> A clairvoyant map generator
 </b> </a> <br></li>
					<li class="sidebar"><a class="backgroundlink" href="An_adjustable_version.html" id="section_page_5"> Adjusting the amounts of grass, sand, and water
 </a> <br></li>
					<li class="sidebar"><a class="backgroundlink" href="WFC.html" id="section_page_6"> Constraint-based maps in the game industry
 </a> <br></li>
			</ol>
	<script>
		document.addEventListener('keyup', function(e) {
			if (e.key >= '1' && e.key <= '9') document.getElementById('section_page_'+e.key).click()
		}, false);
	</script>
	</p>
	<br>
	<h5>Navigation</h5>
	<p style="text-align: left;">
	<table style="border: none;">
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"> <b>Next:</b> </td>
				<td style="border: none;"> 
					<a title="Click or press &#8594;" class="simplelink" id="NextPage" href="An_adjustable_version.html">Tuning it
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta") || e.getModifierState("Control")) return
					if (e.key == 'ArrowRight' || e.key == "Return")
					  document.getElementById('NextPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"> <b>Previous:</b> </td>
				<td style="border: none;"> 
					<a title="Click or press &#8592;" class="simplelink" id="PreviousPage" href="Propagating_constraints.html">Propagating constraints
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowLeft') 
						document.getElementById('PreviousPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"> <b>Up:</b> </td>
				<td style="border: none;"> 
					<a title="Click or press &#8593;" class="simplelink" id="UpPage" href="Map_generation.html">Map generation
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowUp') document.getElementById(e.getModifierState("Control")?'linkToIndex':'UpPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"><b>Next &sect;:</b></td>
				<td style="border: none;"> 
					<a title="Click or press Control-&#8594;" class="simplelink" id="NextSectionPage" href="Clairvoyant_languages_in_real_life.html">Clairvoyant languages in real life
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowRight'  && e.getModifierState("Control")) document.getElementById('NextSectionPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"><b>Prev &sect;:</b></td>
				<td style="border: none;"> 
					<a title="Click or press Control-&#8592;" class="simplelink" id="PreviousSectionPage" href="Comparing_solutions.html">Least-cost paths
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowLeft'  && e.getModifierState("Control")) document.getElementById('PreviousSectionPage').click()
				}, false);
			</script>
	</table>
	</p>
	<div style="color: grey; padding-top: .5rem;">
		<a style="color: grey;" href="mailto:ian@northwestern.edu?subject=Comment on DPGD/Writing_a_constraint_propagator.html">Send feedback on this page</a>
	</div>
</div>

		</div>
	</div>
</div>



<div class="container-fluid footer">
	<div class="container">
		<div class="row">
			<div class="col-10 col-lg-8 footer-contents">
				<div class="text-muted">
					<h4><a class="simplelink" href="index.html">Declarative Programming for Game Designers</a></h4>

					Copyright &copy; 2025 Ian Horswill
				</div>
				<div class="text-muted">
					<a href="https://github.com/rzubek/mies">Made by Booker, based on Rob Zubek's Mies (Crown Theme)</a>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	document.querySelectorAll('.language-step').forEach(e => {e.title = 'Click here to try the code'; });
</script>

<!-- this is required for bootstrap -->

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

</body>
</html>
