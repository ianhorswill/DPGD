
<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- generic metadata -->
	<title>Dynamic reflection&#xA;</title>
	<meta name="author" content="Ian Horswill">
	<meta name="description" content="An introduction to declarative programming with applications to vidoegames">
	<meta name="generator" content="Booker">

	<!-- seo helpers: generic, twitter, facebook/opengraph -->
	<meta itemprop="name" content="Dynamic reflection&#xA;">
	<meta name="twitter:title" content="Dynamic reflection&#xA;">
	<meta property="og:title" content="Dynamic reflection&#xA;" />
	<meta property="og:type" content="article" />
	<meta property="og:site_name" content="Declarative Programming for Game Designers" />
	
	<!-- stylesheets -->
	<!-- bootstrap needs to come first -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

	<!-- then our style sheet -->
	<link rel="stylesheet" href="site.css"> 

	<!-- sample fonts, please feel free to replace with your preferred ones -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat|Public+Sans:400,700&display=swap&subset=latin-ext"> 

	<!-- highlightjs is used for source code formatting inside <code> tags. feel free to remove it. -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/atom-one-dark.min.css">
	<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>
	<script src="step.js"></script>
	<script src="NDScript.js"></script>
	<script>hljs.highlightAll();</script>
	
	<!-- use MathJax for latex rendering -->
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

	<!-- Use mermaid to render diagrams -->
	<script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    </script>
</head>

<body>
<div class="container-fluid shadow header">
	<div class="container">
		<div class="col-md-7 header-contents">
				<a class="backgroundlink" href="Part_I.html"> Part I
 </a>
&nbsp;&#x25BB;&nbsp;				<a class="backgroundlink" href="Clairvoyant_programming.html"> Clairvoyant programming
 </a>
&nbsp;&#x25BB;&nbsp;				<a class="backgroundlink" href="The_Step_language.html"> Step
 </a>
&nbsp;&#x25BB;&nbsp;				<a class="backgroundlink" href="Reflection.html"> Reflection
 </a>
			<h1><a id="linkToIndex" class="simplelink" href="index.html">Dynamic reflection
</a></h1>
					<p>
					<span style="padding:.25rem; padding-left:.5rem; padding-right:.5rem; background-color:orange; color:black;">
					   alpha test
					</span>
					</p>
		</div>
	</div>
</div>

	<!-- Make clicking On Step code pop up a step interpreter and copy the code into the clipboard -->
	<script>
	document.querySelector("body").addEventListener('click', function(e) {
		var element = e.target.closest('code');
		if(element !== null) {
			if (element.classList.contains('language-Step')) {
				var interp = window.open("https://ianhorswill.github.io/StepSandbox", "Step sandbox");
				var handler = function(e) { 
					interp.postMessage(element.textContent, "*");
					window.removeEventListener('message', handler);
				};
				window.addEventListener('message', handler);
			} else if (element.classList.contains('language-NDScript')) {
				var interp = window.open("https://ianhorswill.github.io/NDScriptSandbox", "NDScript sandbox");
				var handler = function(e) { 
					interp.postMessage(element.textContent, "*");
					window.removeEventListener('message', handler);
				};
				window.addEventListener('message', handler);
			}
		}
	}, false);
	</script>



<div class="container-fluid">
	<div class="row justify-content-center">
		<div class="col-md-7 index-contents">
			<div class="container shadow blog-contents">

<p>Dynamic reflection allows a Step program to query its own execution history.  The two main predicates for this are <code>PreviousCall</code> and <code>UniqueCall</code>.</p>
<h2 id="previouscall"><code>PreviousCall</code></h2>
<p><code>[PreviousCall ?call]</code> is true if <code>?call</code> matches some call that has been successful in the chosen execution path.  That is, it ignores calls from failed execution paths and only considers the one we're running.  It also ignores calls that don't match <code>?call</code>. </p>
<p>We generally use this to ask about calls to a specific task.  For example, in our previous <a href="Planning_using_reflection.html">dumb planner</a>, we wrote the actions to print to the screen because otherwise we wouldn't know what actions were selected:</p>
<pre><code class="language-step">Shoot ?who: [Gun ?gun] [Require [Location ?gun me]] [Require [Loaded ?gun]] You shoot ?who with the ?gun.  [Effect [Dead ?who]]
Pickup ?what: [Require [Location ?what floor]] You pick up the ?what.  [Effect [Location ?what me]]
Load ?gun ?ammo: [Gun ?gun] [Require [Location ?gun me]]  [Ammo ?ammo] [Require [Location ?ammo me]] You load the ?gun.  [Effect [Loaded ?gun]]
</code></pre>
<p>But we might now want the planner to print to the screen; we might just want to get a list of the actions in the plan.  Easy!  Here's our planner:</p>
<pre><code class="language-step">[predicate]
Require ?condition: [Succeeds ?condition]
Require ?condition: [Fails ?condition] [Achieves ?action ?condition] [Succeeds ?action]

[predicate]
Achieves ?action ?effect: [Action ?action] [Method ?action ?subgoals] [Member [Effect ?effect] ?subgoals]
</code></pre>
<p>Every action is run by the second line of <code>Require</code>, and it's generated by <code>Achieves</code>.  So to find out what actions were run, we just ask for all the calls to <code>Achieves</code>:</p>
<pre><code class="language-step">Plan ?goal ?plan: [Require ?goal] [FindAll ?action [PreviousCall [Achieves ?action ?]] ?plan]
</code></pre>
<p>Now we can call <code>Plan</code> with a goal to achieve and it will return the generated plan in <code>?plan</code>.</p>
<h2 id="uniquecall"><code>UniqueCall</code></h2>
<p><code>UniqueCall</code> finds a solution to a query that doesn't match a previous solution:</p>
<pre><code class="language-step">[UniqueCall [Task ?args ...]]
</code></pre>
<p>This runs <code>[Task ?args ...]</code>, which will hopefully find a solution, binding the various <code>?args</code> in the process.  <code>UniqueCall</code> then matches that against <em>previous</em> calls to <code>Task</code>.  If it matches, it backtracks and generates a new solution to <code>[Task ?args ...]</code>.  It repeats this until it finds a solution that hasn't been used before.</p>
<p>This is useful in systems that do procedural generation.  Often times, you want to generate a monster, but you want to generate a <em>different</em> monster that the ones you've previously generated.  You can use <code>UniqueCall</code> to do that.</p>
<p>Another use for <code>UniqueCall</code> is for casting in procedural narrative systems.  You have a bunch of characters, and you have a bunch of roles.  You want to assign characters to roles, but you don't want to cast the same character in two different roles.  This will do that for you:</p>
<pre><code class="language-step">[predicate]
CastCharacter ?c: [Character ?c]

[fluent]
Cast ?c ?role: [UniqueCall [CastCharacter ?c]] [now [Cast ?c ?role]]
</code></pre>
<p>Now, anytime you want to know who is cast as the hero, do <code>[Cast ?c hero]</code>.  If someone is already cast in that role, it binds <code>?c</code> to that character.  If not, it chooses a character who's never been cast in a role before, then updates the <code>Cast</code> predicate using <code>now</code>.</p>


<table style="border: none; width: 100%; table-layout: fixed; margin-top: 2rem;">
<tbody>
<tr style="border: none;">
				<td style="border: none; vertical-align: top; "> 
                    <b>Previous:</b> 
					<a title="Click or press &#8592;" class="simplelink" id="PreviousPage" href="Design_rule_checking.html">Design-rule checking
</a><br>
				</td>
				<td style="border: none; vertical-align: top; text-align: right;"> 
                    <b>Next:</b>  
					<a title="Click or press &#8594;" class="simplelink" id="NextPage" href="Tagged_grammars.html">Tagged grammars
</a><br>
				</td>			
</tr>
</tbody>
</table>
			</div>
		</div>

		<div class="col-md-3">

<div class="container-fluid sidebar">
		<h3 style="text-align: right;">Incomplete draft:<br>do not cite!</h3>
			<h5>Dynamic reflection
</h5>
			<ol start="1">
					<li class="sidebar"><a class="backgroundlink" href="Tagged_grammars.html" id="section_page_1"> Tagged grammars
 </a> <br></li>
			</ol>
	<script>
		document.addEventListener('keyup', function(e) {
			if (e.key >= '1' && e.key <= '9') document.getElementById('section_page_'+e.key).click()
		}, false);
	</script>
	</p>
	<br>
	<h5>Navigation</h5>
	<p style="text-align: left;">
	<table style="border: none;">
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"> <b>Next:</b> </td>
				<td style="border: none;"> 
					<a title="Click or press &#8594;" class="simplelink" id="NextPage" href="Tagged_grammars.html">Tagged grammars
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta") || e.getModifierState("Control")) return
					if (e.key == 'ArrowRight' || e.key == "Return")
					  document.getElementById('NextPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"> <b>Previous:</b> </td>
				<td style="border: none;"> 
					<a title="Click or press &#8592;" class="simplelink" id="PreviousPage" href="Design_rule_checking.html">Design-rule checking
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowLeft') 
						document.getElementById('PreviousPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"> <b>Up:</b> </td>
				<td style="border: none;"> 
					<a title="Click or press &#8593;" class="simplelink" id="UpPage" href="Reflection.html">Reflection
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowUp') document.getElementById(e.getModifierState("Control")?'linkToIndex':'UpPage').click()
				}, false);
			</script>
			<tr style="border: none;">
				<td style="border: none; vertical-align: top;"><b>Prev &sect;:</b></td>
				<td style="border: none;"> 
					<a title="Click or press Control-&#8592;" class="simplelink" id="PreviousSectionPage" href="Static_reflection.html">Static reflection
</a><br>
				</td>
			</tr>
			<script>
				document.addEventListener('keyup', function(e) {
					if (e.getModifierState("Meta")) return
					if (e.key == 'ArrowLeft'  && e.getModifierState("Control")) document.getElementById('PreviousSectionPage').click()
				}, false);
			</script>
	</table>
	</p>
	<div style="color: grey; padding-top: .5rem;">
		<a style="color: grey;" href="mailto:ian@northwestern.edu?subject=Comment on DPGD/Dynamic_reflection.html">Send feedback on this page</a>
	</div>
</div>

		</div>
	</div>
</div>



<div class="container-fluid footer">
	<div class="container">
		<div class="row">
			<div class="col-10 col-lg-8 footer-contents">
				<div class="text-muted">
					<h4><a class="simplelink" href="index.html">Declarative Programming for Game Designers</a></h4>

					Copyright &copy; 2025 Ian Horswill
				</div>
				<div class="text-muted">
					<a href="https://github.com/rzubek/mies">Made by Booker, based on Rob Zubek's Mies (Crown Theme)</a>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	document.querySelectorAll('.language-step').forEach(e => {e.title = 'Click here to try the code'; });
</script>

<!-- this is required for bootstrap -->

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

</body>
</html>
